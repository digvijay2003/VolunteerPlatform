<style>
    /* Custom styles to refine the UI */
    :root {
        --bs-primary: #007788;
        --bs-success: #28a745;
        --bs-info: #17a2b8;
        --bs-warning: #ffc107;
        --bs-danger: #dc3545;
        --bs-light: #f8f9fa;
        --bs-dark: #343a40;
    }

    body {
        /* Add a subtle background gradient */
        background: linear-gradient(135deg, #e0f7fa, #f0f4f8);
        min-height: 100vh;
    }

    .profile-avatar {
        box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.5); /* Add a subtle white halo */
    }
    .card-header-primary {
        background-color: var(--bs-primary);
        color: white;
        border-radius: var(--bs-card-border-radius) var(--bs-card-border-radius) 0 0;
        padding: 1rem 1.5rem;
    }
    .card-footer-transparent {
        background-color: transparent;
        border-top: none;
    }
    .status-badge-success {
        background-color: var(--bs-success);
        color: white;
    }
    .status-badge-warning {
        background-color: var(--bs-warning);
        color: var(--bs-dark);
    }
    .status-badge-danger {
        background-color: var(--bs-danger);
        color: white;
    }
    .status-badge-secondary {
        background-color: var(--bs-secondary);
        color: white;
    }
    .list-group-item:first-child {
        border-top-width: 0;
    }
</style>

<div class="text-center text-muted h5" style="font-weight: 500;">DASHBOARD</div>

<div class="container py-3">
    <div class="row g-4">
        <div class="col-md-12">
        <div class="card shadow-lg border-0 mb-4 rounded-4 overflow-hidden">
            <div class="card-body p-5">
                <div class="d-flex align-items-center mb-4">
                    <div class="flex-shrink-0 me-4">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center profile-avatar" style="width: 100px; height: 100px;">
                            <span class="fs-1 fw-bold"><%= user.name.split(' ').map(n => n[0]).join('').toUpperCase() %></span>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h1 class="display-6 fw-bold mb-1"><%= user.name %></h1>
                        <p class="text-muted lead"><%= user.email %></p>
                        <span class="badge bg-secondary text-white rounded-pill px-3 py-2">Member since <%= new Date(user.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %></span>
                    </div>
                </div>
                <hr class="my-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <p class="mb-0 fs-5"><strong class="me-3 text-primary"><i class="bi bi-telephone-fill"></i></strong><%= user.phone %></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-0 fs-5"><strong class="me-3 text-primary"><i class="bi bi-geo-alt-fill"></i></strong><%= user.address ? `${user.address.city}, ${user.address.state}` : 'N/A' %></p>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">

            <% if (user.volunteer && user.volunteer.currentAssignments) { %>
                <% const assignment = user.volunteer.currentAssignments; %>
                <% const donation = assignment.food_donation; %>
                <% const request = assignment.food_request; %>

                <div class="card shadow-lg border-0 mb-4 rounded-4" id="active-delivery-card">
                    <div class="card-header card-header-primary">
                        <h4 class="mb-0"><i class="bi bi-truck-fill me-2"></i>Active Delivery Task</h4>
                    </div>
                    <div class="card-body p-4">
                        <div id='map' style='width: 100%; height: 500px;' class="mb-4 rounded"></div>

                        <div class="row g-4">
                            <div class="col-md-12">
                                <h5 class="fw-bold text-success mb-3"><i class="bi bi-box-arrow-in-right me-2"></i>Pickup from Donor</h5>
                                <p class="mb-2"><strong>Name:</strong> <%= donation.donor_name %></p>
                                <p class="mb-2"><strong>Address:</strong> <%= donation.location_text %></p>
                                <p class="mb-2"><strong>Phone:</strong> <%= donation.donor_phone %></p>
                                <p class="mb-0"><strong>Food:</strong> <%= donation.food_type %> (<%= donation.quantity.amount %> <%= donation.quantity.unit %>)</p>
                            </div>
                            <div class="col-md-12">
                                <h5 class="fw-bold text-info mb-3"><i class="bi bi-flag-fill me-2"></i>Deliver to Requester</h5>
                                <p class="mb-2"><strong>Name:</strong> <%= request.requester_name %></p>
                                <p class="mb-2"><strong>Address:</strong> <%= request.location_text %></p>
                                <p class="mb-2"><strong>Phone:</strong> <%= request.requester_phone %></p>
                            </div>
                        </div>
                        <hr class="my-4">

                        <div class="d-grid gap-3">
                            <% if (assignment.deliveryStatus === 'assigned') { %>
                                <form action="/delivery/<%= assignment._id %>/pickup" method="POST">
                                    <button type="submit" class="btn btn-success btn-sm w-100 rounded-pill py-3 fw-bold shadow-sm">Confirm Food Pickup</button>
                                </form>
                            <% } else if (assignment.deliveryStatus === 'in_transit') { %>
                                <form action="/delivery/<%= assignment._id %>/deliver" method="POST">
                                    <button type="submit" class="btn btn-info btn-lg w-100 rounded-pill py-3 fw-bold shadow-sm">Confirm Delivery to Requester</button>
                                </form>
                            <% } else if (assignment.deliveryStatus === 'delivered') { %>
                                <div class="alert alert-success text-center py-3 rounded-3">
                                    <h5 class="mb-0"><i class="bi bi-check-circle-fill me-2"></i>Delivery Completed!</h5>
                                    <p class="mb-0 mt-1">Thank you for your service.</p>
                                </div>
                            <% } %>

                            <% if (assignment.deliveryStatus !== 'delivered') { %>
                                <form action="/delivery/<%= assignment._id %>/fail" method="POST">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100 mt-2 rounded-pill fw-bold">Report an Issue</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } %>


            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white pb-0 pt-4 px-4 border-bottom-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-box-seam-fill me-2 text-success"></i>Recent Donations
                            </h5>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody>
                                    <% if(user.food_donations && user.food_donations.length > 0) { %>
                                        <% user.food_donations.slice(0, 5).forEach(donation => { %>
                                            <tr>
                                                <td class="ps-4 py-3">
                                                    <a href="/donations/<%= donation._id %>" class="text-decoration-none text-dark">
                                                        <strong class="d-block"><%= donation.food_type %> - <%= donation.quantity.amount %> <%= donation.quantity.unit %></strong>
                                                        <span class="text-muted small"><i class="bi bi-calendar-event me-1"></i> <%= new Date(donation.createdAt).toLocaleDateString() %></span><br>
                                                        <span class="text-muted small"><i class="bi bi-geo-alt-fill me-1"></i> <%= donation.location_text %></span>
                                                    </a>
                                                </td>
                                                <td class="text-end pe-4 py-3">
                                                    <span class="badge rounded-pill <%= getStatusBadge(donation.status) %> text-uppercase">
                                                        <%= donation.status %>
                                                    </span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="2" class="text-center text-muted p-4">
                                                <i class="bi bi-exclamation-circle-fill me-1"></i>No donations found.
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <div class="card-footer card-footer-transparent text-center pt-3 pb-4">
                            <a href="/donations" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
                                View All Donations
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 rounded-4">
                        <div class="card-header bg-white pb-0 pt-4 px-4 border-bottom-0">
                            <h5 class="card-title mb-0"><i class="bi bi-card-checklist me-2 text-info"></i>Recent Requests</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <tbody>
                                    <% if(user.food_requests && user.food_requests.length > 0) { %>
                                        <% user.food_requests.slice(0, 5).forEach(request => { %>
                                            <tr>
                                                <td class="ps-4 py-3">
                                                    <a href="/requests/<%= request._id %>" class="text-decoration-none text-dark">
                                                        <strong class="d-block"><%= request.food_type %></strong>
                                                        <span class="text-muted small"><%= new Date(request.createdAt).toLocaleDateString() %></span>
                                                    </a>
                                                </td>
                                                <td class="text-end pe-4 py-3">
                                                    <span class="badge rounded-pill <%= getStatusBadge(request.status) %>"><%= request.status %></span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="2" class="text-center text-muted p-4">No requests found.</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer card-footer-transparent text-center pt-3 pb-4">
                            <a href="/requests" class="btn btn-outline-secondary btn-sm rounded-pill px-3">View All Requests</a>
                        </div>
                    </div>
                </div>
            </div>

            <% if (user.volunteer) { %>
                <div class="card shadow-lg border-0 my-4 rounded-4 overflow-hidden">
                    <div class="card-header card-header-primary">
                        <h4 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Volunteer Profile</h4>
                    </div>
                    <div class="card-body p-5">
                        <% if (user.volunteer.isBanned) { %>
                            <div class="alert alert-danger p-4 rounded-3">
                                <h5 class="alert-heading fw-bold"><i class="bi bi-x-circle-fill me-2"></i>Account Banned</h5>
                                <p class="mb-0"><strong>Reason:</strong> <%= user.volunteer.bannedReason || 'No reason provided.' %></p>
                            </div>
                        <% } %>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <p class="text-muted small mb-1">Username</p>
                                <p class="fs-5 fw-bold mb-0"><%= user.volunteer.username %></p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-muted small mb-1">Email</p>
                                <p class="fs-5 fw-bold mb-0"><%= user.volunteer.email %></p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-muted small mb-1">Phone</p>
                                <p class="fs-5 fw-bold mb-0"><%= user.volunteer.phone %></p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-muted small mb-1">Location</p>
                                <p class="fs-5 fw-bold mb-0"><%= user.volunteer.location %></p>
                            </div>
                        </div>
                        <hr>
                        <div class="mt-4">
                            <h5 class="mb-3"><i class="bi bi-tools me-2 text-secondary"></i>Skills</h5>
                            <% if (user.volunteer.skills && user.volunteer.skills.length > 0) { %>
                                <% user.volunteer.skills.forEach(skill => { %>
                                    <span class="badge rounded-pill bg-dark fw-normal me-2 fs-6 px-3 py-2"><%= skill.charAt(0).toUpperCase() + skill.slice(1) %></span>
                                <% }) %>
                            <% } else { %>
                                <p class="text-muted">No skills listed.</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <div class="card shadow-lg border-0 my-4 rounded-4">
                    <div class="card-body text-center p-5">
                        <i class="bi bi-person-plus-fill text-primary display-2"></i>
                        <h3 class="card-title fw-bold mt-4 mb-2">Ready to Make a Difference?</h3>
                        <p class="card-text text-muted mx-auto" style="max-width: 500px;">Join our team of dedicated volunteers and become a vital part of our community's support system.</p>
                        <a href="/volunteer/register" class="btn btn-primary btn-lg mt-3 rounded-pill px-5 py-3 fw-bold shadow-sm">Become a Volunteer</a>
                    </div>
                </div>
            <% } %>
        </div>

        <div class="col-lg-4">

            <div class="card shadow-lg border-0 mb-4 rounded-4">
                <div class="card-body p-5 text-center">
                    <h4 class="card-title fw-bold mb-4"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h4>
                    <div class="d-grid gap-3">
                        <a href="/donations/new" class="btn btn-success btn-lg rounded-pill py-3 fw-bold shadow-sm"><i class="bi bi-box-seam-fill me-2"></i>Donate Food</a>
                        <a href="/requests/new" class="btn btn-info btn-lg rounded-pill py-3 fw-bold shadow-sm"><i class="bi bi-card-checklist me-2"></i>Request Food</a>
                    </div>
                </div>
            </div>

            <% if (user.volunteer) { %>
                <div class="card shadow-sm border-0 mb-4 rounded-4">
                    <div class="card-header bg-white py-4 px-4">
                        <h5 class="card-title mb-0"><i class="bi bi-person-check-fill me-2 text-primary"></i>Volunteer Status</h5>
                    </div>
                    <div class="card-body p-4">
                        <% if (user.volunteer.governmentIdVerified) { %>
                            <div class="alert alert-success d-flex align-items-center py-3 px-4 rounded-3">
                                <i class="bi bi-patch-check-fill me-3 fs-4"></i> <strong class="me-auto fs-6">ID Verified</strong>
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning d-flex align-items-center py-3 px-4 rounded-3">
                                <div class="d-flex w-100 align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                                    <div class="flex-grow-1">
                                        <strong class="d-block fs-6">ID Not Verified</strong>
                                        <small class="text-muted">Verification required for assignments.</small>
                                    </div>
                                    <a href="/volunteer/verify-id" class="btn btn-warning btn-sm fw-bold">Verify Now</a>
                                </div>
                            </div>
                        <% } %>
                        
                        <ul class="list-group list-group-flush mt-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <span>Status</span> 
                                <% if (user.volunteer.status === 'active') { %><span class="badge bg-success rounded-pill px-3 py-2">Active</span><% } %>
                                <% if (user.volunteer.status === 'inactive') { %><span class="badge bg-warning text-dark rounded-pill px-3 py-2">Inactive</span><% } %>
                                <% if (user.volunteer.status === 'suspended') { %><span class="badge bg-danger rounded-pill px-3 py-2">Suspended</span><% } %>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <span>Availability</span> 
                                <% if (user.volunteer.availability) { %><span class="badge bg-info rounded-pill px-3 py-2">Available</span><% } else { %><span class="badge bg-secondary rounded-pill px-3 py-2">Unavailable</span><% } %>
                            </li>
                            <li class="list-group-item px-0 py-3">
                                <span class="d-block mb-2">Rating</span>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar bg-warning text-dark fw-bold" role="progressbar" style="width: <%= (user.volunteer.rating / 5) * 100 %>%;" aria-valuenow="<%= user.volunteer.rating %>" aria-valuemin="0" aria-valuemax="5">
                                        <%= user.volunteer.rating.toFixed(1) %> / 5.0
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <span>Current Assignments</span>
                                <span class="badge bg-primary rounded-pill fs-6 px-3 py-2"><%= user.volunteer.currentAssignments ? 1 : 0 %></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <span>Completed Assignments</span>
                                <span class="badge bg-primary rounded-pill fs-6 px-3 py-2"><%= user.volunteer.completedAssignments ? user.volunteer.completedAssignments.length : 0 %></span>
                            </li>
                        </ul>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
    // Only run this script if the active delivery card exists
    if (document.getElementById('active-delivery-card')) {
        // Pass data from EJS to JS
        const mapboxToken = "<%= mapboxAccessToken %>";
        const donorCoords = <%- JSON.stringify(user.volunteer.currentAssignments.food_donation.location_geo.coordinates) %>;
        const requesterCoords = <%- JSON.stringify(user.volunteer.currentAssignments.food_request.location_geo.coordinates) %>;

        mapboxgl.accessToken = mapboxToken;
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: donorCoords, // Start map centered on donor
            zoom: 11
        });

        // Add Marker for Donor (Pickup)
        new mapboxgl.Marker({ color: '#28a745' }) // Green
            .setLngLat(donorCoords)
            .setPopup(new mapboxgl.Popup().setHTML("<h5>Pickup Location</h5>"))
            .addTo(map);

        // Add Marker for Requester (Dropoff)
        new mapboxgl.Marker({ color: '#17a2b8' }) // Blue/Info
            .setLngLat(requesterCoords)
            .setPopup(new mapboxgl.Popup().setHTML("<h5>Delivery Location</h5>"))
            .addTo(map);

        // Fetch and display the route
        async function getRoute() {
            const response = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${donorCoords[0]},${donorCoords[1]};${requesterCoords[0]},${requesterCoords[1]}?steps=true&geometries=geojson&access_token=${mapboxToken}`);
            const data = await response.json();
            const route = data.routes[0].geometry.coordinates;

            map.addLayer({
                id: 'route',
                type: 'line',
                source: {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: route
                        }
                    }
                },
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#007bff',
                    'line-width': 5
                }
            });
            // Fit map to the route bounds
             const bounds = new mapboxgl.LngLatBounds(donorCoords, requesterCoords);
             map.fitBounds(bounds, { padding: 50 });
        }

        getRoute();
    }
</script>